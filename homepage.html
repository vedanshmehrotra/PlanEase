<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Ease</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="homepage-new.css">
    <link rel="stylesheet" href="animated-background.css">
</head>
<body>
    <div class="bg-container">
        <div class="dot-grid"></div>
        <div class="wave wave1"></div>
        <div class="wave wave2"></div>
        <div class="wave wave3"></div>
        <div class="shape circle circle1"></div>
        <div class="shape circle circle2"></div>
        <div class="shape circle circle3"></div>
        <div class="shape circle circle4"></div>
        <div class="shape triangle triangle1"></div>
        <div class="shape triangle triangle2"></div>
        <div class="shape triangle triangle3"></div>
        <div class="shape square square1"></div>
        <div class="shape square square2"></div>
        <div class="shape square square3"></div>
        <div class="shape square square4"></div>
        <div class="shape line line1"></div>
        <div class="shape line line2"></div>
        <div class="shape line line3"></div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div class="menu">
                <h2>Menu</h2>
                <div class="menu-item" onclick="redirectTo('forumpagetodo.html')">üìù To-Do List</div>
                <div class="menu-item" onclick="redirectTo('forumpagenote.html')">üìí Notes</div>
                <div id="menu-slidebar" class="slidebar-toggle">Show More ‚ñº</div>
            </div>
            <div class="dates">
                <h2>Dates</h2>
                <!-- Date items will be dynamically added here -->
                <div class="date-item">Today</div>
                <div class="date-item">Tomorrow</div>
                <div class="date-item">This Week</div>
                <div id="dates-slidebar" class="slidebar-toggle">Show More ‚ñº</div>
            </div>
            <div class="completed-tasks">
                <h2>Completed Tasks</h2>
                <ul id="completed-tasks-list">
                    <!-- Completed tasks will be added here -->
                </ul>
                <div id="completed-slidebar" class="slidebar-toggle">Show More ‚ñº</div>
            </div>
            <button onclick="createNewEntry('todo')">New To-Do</button>
            <button onclick="createNewEntry('notes')">New Note</button>
        </div>
        <div class="content">
            <h1 class="title">PlanEase</h1>
            <div id="todo" class="tab-content">Your personal to-do list awaits...</div>
            <div id="notes" class="tab-content hidden">Jot down your creative thoughts here...</div>
            <div class="dashboard">
                <h2>Dashboard</h2>
                <div class="dashboard-stats">
                    <div class="dashboard-stat" onclick="redirectTo('forumpagetodo.html')" style="cursor: pointer;">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-info">
                            <span class="stat-label">Total Tasks</span>
                            <span id="total-tasks" class="stat-value">0</span>
                        </div>
                    </div>
                    <div class="dashboard-stat" onclick="redirectTo('forumpagenote.html')" style="cursor: pointer;">
                        <div class="stat-icon">üìí</div>
                        <div class="stat-info">
                            <span class="stat-label">Total Notes</span>
                            <span id="total-notes" class="stat-value">0</span>
                        </div>
                    </div>
                    <div class="dashboard-stat" onclick="redirectTo('forumpagetodo.html')" style="cursor: pointer;">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-info">
                            <span class="stat-label">Completed Tasks</span>
                            <span id="completed-tasks" class="stat-value">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="recent-tasks">
                <h2>Recent Tasks</h2>
                <div class="tasks-container">
                    <ul id="recent-tasks-list">
                        <!-- Tasks will be dynamically added here -->
                    </ul>
                </div>
            </div>
            <div class="recent-notes">
                <h2>Recent Notes</h2>
                <div class="notes-container">
                    <ul id="recent-notes-list">
                        <!-- Notes will be dynamically added here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAuthHeaders, requireAuth } from './js/auth.js';

        // Check authentication
        if (!requireAuth()) {
            throw new Error('Authentication required');
        }

        // Make redirectTo available globally
        window.redirectTo = function(url) {
            window.location.href = url;
        };

        async function createTask(taskData) {
            try {
                const response = await fetch('http://localhost:5000/api/tasks', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(taskData)
                });

                if (!response.ok) {
                    throw new Error('Failed to create task');
                }

                alert('Task created successfully!');
                loadTasksAndNotes(); // Refresh the task list
            } catch (error) {
                console.error('Error creating task:', error);
                alert('Failed to create task. Please try again.');
            }
        }

        window.createNewEntry = function(type) {
            if (type === 'todo') {
                window.location.href = 'forumpagetodo.html';
            } else if (type === 'notes') {
                window.location.href = 'forumpagenote.html';
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadTasksAndNotes();
        });

        async function loadTasksAndNotes() {
            try {
                console.log('Loading tasks and notes...');
                const headers = getAuthHeaders();
                console.log('Using headers:', headers);

                const [tasksResponse, notesResponse] = await Promise.all([
                    fetch('http://localhost:5000/api/tasks', {
                        headers: headers
                    }),
                    fetch('http://localhost:5000/api/notes', {
                        headers: headers
                    })
                ]);

                if (!tasksResponse.ok) {
                    const errorData = await tasksResponse.json();
                    console.error('Tasks error:', errorData);
                    throw new Error(errorData.error || 'Failed to load tasks');
                }

                if (!notesResponse.ok) {
                    const errorData = await notesResponse.json();
                    console.error('Notes error:', errorData);
                    throw new Error(errorData.error || 'Failed to load notes');
                }

                const tasks = await tasksResponse.json();
                const notes = await notesResponse.json();

                console.log('Loaded tasks:', tasks);
                console.log('Loaded notes:', notes);

                // Separate active and completed tasks
                const activeTasks = tasks.filter(task => !task.completed);
                const completedTasks = tasks.filter(task => task.completed);

                // Populate tasks and notes
                populateTasks(activeTasks, completedTasks);
                populateNotes(notes);
            } catch (error) {
                console.error('Error loading tasks and notes:', error);
                alert('Failed to load tasks and notes. Please try again.');
            }
        }

        function populateTasks(activeTasks, completedTasks) {
            console.log('Populating tasks:', { active: activeTasks.length, completed: completedTasks.length });
            const recentTasksList = document.getElementById('recent-tasks-list');
            const completedTasksList = document.getElementById('completed-tasks-list');
            recentTasksList.innerHTML = '';
            completedTasksList.innerHTML = '';

            if (activeTasks.length === 0) {
                recentTasksList.innerHTML = '<li>No active tasks</li>';
            } else {
                activeTasks.forEach((task, index) => addTaskToList(task, index));
            }

            if (completedTasks.length === 0) {
                completedTasksList.innerHTML = '<li>No completed tasks</li>';
            } else {
                completedTasks.forEach(task => addCompletedTask(task));
            }

            document.getElementById('total-tasks').textContent = activeTasks.length;
            document.getElementById('completed-tasks').textContent = completedTasks.length;
        }

        function populateNotes(notes) {
            console.log('Populating notes:', notes.length);
            const recentNotesList = document.getElementById('recent-notes-list');
            const datesSection = document.querySelector('.dates');
            recentNotesList.innerHTML = '';

            if (notes.length === 0) {
                recentNotesList.innerHTML = '<li>No notes</li>';
            } else {
                notes.forEach((note, index) => addNoteToList(note, index));
            }

            // Populate dates section with notes having alarm dates
            const dateItems = datesSection.querySelectorAll('.date-item');
            dateItems.forEach((item, index) => {
                if (index >= 3) item.remove(); // Remove dynamically added items
            });
            notes.forEach(note => {
                if (note.alarmDate) {
                    const dateItem = document.createElement('div');
                    dateItem.className = 'date-item';
                    dateItem.textContent = `${note.name} - ${note.alarmDate}`;
                    datesSection.appendChild(dateItem);
                }
            });

            document.getElementById('total-notes').textContent = notes.length;
        }

        async function updateTaskStatus(taskId, completed) {
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ completed })
                });

                if (!response.ok) {
                    throw new Error('Failed to update task status');
                }

                loadTasksAndNotes();
            } catch (error) {
                console.error('Error updating task status:', error);
                alert('Failed to update task status. Please try again.');
            }
        }

        async function deleteNote(noteId) {
            try {
                const response = await fetch(`http://localhost:5000/api/notes/${noteId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to delete note');
                }

                loadTasksAndNotes();
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Failed to delete note. Please try again.');
            }
        }

        // Function to add a task to the active list
        function addTaskToList(task, index) {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.innerHTML = `
                <div class="task-content">
                    <input type="checkbox" class="task-checkbox" id="task-${index}" ${task.completed ? 'checked' : ''}>
                    <div class="task-details">
                        <span class="task-title">${task.title}</span>
                        ${task.category ? `<span class="task-category">${task.category}</span>` : ''}
                        ${task.priority ? `<span class="task-priority ${task.priority.toLowerCase()}">${task.priority}</span>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="edit-btn" onclick="editTask('${task._id}')">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteTask('${task._id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `;

            const checkbox = li.querySelector('.task-checkbox');
            checkbox.addEventListener('change', () => {
                updateTaskStatus(task._id, checkbox.checked);
            });

            document.getElementById('recent-tasks-list').appendChild(li);
        }

        // Function to add a completed task to the completed list
        function addCompletedTask(task) {
            const li = document.createElement('li');
            li.className = 'completed-task-item';
            li.innerHTML = `
                <span class="task-title">${task.title}</span>
            `;
            document.getElementById('completed-tasks-list').appendChild(li);
        }

        // Function to add a note to the list
        function addNoteToList(note, index) {
            const li = document.createElement('li');
            li.className = 'note-item';
            li.innerHTML = `
                <div class="note-content">
                    <div class="note-details">
                        <span class="note-title">${note.name}</span>
                        <span class="note-description">${note.description.substring(0, 50)}${note.description.length > 50 ? '...' : ''}</span>
                        ${note.alarmDate && note.alarmTime ? `
                            <span class="note-alarm">‚è∞ ${new Date(note.alarmDate + 'T' + note.alarmTime).toLocaleString()}</span>
                        ` : ''}
                    </div>
                    <div class="note-actions">
                        <button class="edit-btn" onclick="editNote('${note._id}')">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteNote('${note._id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            document.getElementById('recent-notes-list').appendChild(li);
        }

        // Add edit functions to window object
        window.editTask = function(taskId) {
            window.location.href = `forumpagetodo.html?edit=${taskId}`;
        };

        window.editNote = function(noteId) {
            window.location.href = `forumpagenote.html?edit=${noteId}`;
        };

        window.deleteTask = async function(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete task');
                }
                
                loadTasksAndNotes();
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task. Please try again.');
            }
        };
    </script>
</body>
</html>